name: Sync metadata from contrib

on:
 workflow_dispatch:
 schedule:
    - cron: "30 1 1,15 * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  download_components:
    name: Download components.go
    runs-on: ubuntu-latest
    steps:
     - name: Download components.go
       run: curl -L https://raw.githubusercontent.com/signalfx/splunk-otel-collector/main/internal/components/components.go -o /scripts/cfgschema/components.go
 
     - name: Commit and push changes
       run: |
         git config --global user.name 'github-actions[bot]'
         git config --global user.email 'github-actions[bot]@users.noreply.github.com'
         git add /scripts/cfgschema/components.go
         git commit -m 'Update components.go'
         git push
       env:
         GITHUB_TOKEN: ${{ secrets.UPDATE_TOKEN }}
  sync_metadata:
    name: Sync metadata
    runs-on: ubuntu-latest
    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - uses: actions/checkout@v3
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'
      - name: Download settings from contrib
        run: |
          cd scripts/cfgschema
          go run .
      - name: Download metrics from contrib
        run: |
          ./scripts/import_metric_metadata.sh
      - name: Commit changes
        uses: EndBug/add-and-commit@v9
        with:
          message: 'Metada update ${{ steps.date.outputs.date }}'
          new_branch: metadata-update-${{ steps.date.outputs.date }}
          add: '*.yaml'
          default_author: github_actor
          push: true
      - name: Create pull request
        run: gh pr create -B main -H metadata-update-${{ steps.date.outputs.date }} --title 'Merge metadata-update-${{ steps.date.outputs.date }} into main' --body 'Automatic sync PR to update reference files from contrib'
        env:
          GH_TOKEN: ${{ secrets.UPDATE_TOKEN }}
